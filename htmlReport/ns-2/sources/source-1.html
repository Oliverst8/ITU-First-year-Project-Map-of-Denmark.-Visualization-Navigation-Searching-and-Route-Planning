


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > ChunkGenerator</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">dk.itu.map.parser</a>
</div>

<h1>Coverage Summary for Class: ChunkGenerator (dk.itu.map.parser)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ChunkGenerator</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/115)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package dk.itu.map.parser;
&nbsp;
&nbsp;import java.io.BufferedOutputStream;
&nbsp;import java.io.DataOutputStream;
&nbsp;import java.io.File;
&nbsp;import java.io.FileNotFoundException;
&nbsp;import java.io.FileOutputStream;
&nbsp;import java.io.FileWriter;
&nbsp;import java.io.IOException;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.stream.IntStream;
&nbsp;
&nbsp;import dk.itu.map.structures.Graph;
&nbsp;import dk.itu.map.structures.Way;
&nbsp;
&nbsp;public class ChunkGenerator implements Runnable {
&nbsp;    // chunk size in coordinate size
<b class="nc">&nbsp;    private final float CHUNK_SIZE = 0.25f;</b>
&nbsp;
<b class="nc">&nbsp;    private final byte amountOfZoomLayers = 5;</b>
&nbsp;
&nbsp;    public float minlat, maxlat, minlon, maxlon;
&nbsp;
&nbsp;    public int chunkColumnAmount, chunkRowAmount, chunkAmount;
&nbsp;
&nbsp;    private ArrayList&lt;ArrayList&lt;ArrayList&lt;Way&gt;&gt;&gt; chunks;
&nbsp;    private File[][] files;
&nbsp;
<b class="nc">&nbsp;    private int tempCounter = 0;</b>
&nbsp;    private List&lt;Way&gt; rawWays;
&nbsp;    private boolean hasMoreWork;
<b class="nc">&nbsp;    private final int MIN_ARRAY_LENGTH = 150_000;</b>
&nbsp;
<b class="nc">&nbsp;    private final Graph graph = new Graph();</b>
&nbsp;
&nbsp;    private Thread chunkingThread;
&nbsp;
<b class="nc">&nbsp;    public ChunkGenerator(float minlat, float maxlat, float minlon, float maxlon) {</b>
<b class="nc">&nbsp;        hasMoreWork = false;</b>
<b class="nc">&nbsp;        rawWays = Collections.synchronizedList(new ArrayList&lt;&gt;(MIN_ARRAY_LENGTH));</b>
<b class="nc">&nbsp;        chunkingThread = new Thread(this);</b>
<b class="nc">&nbsp;        chunkingThread.start();</b>
&nbsp;
<b class="nc">&nbsp;        this.minlat = minlat;</b>
<b class="nc">&nbsp;        this.maxlat = maxlat;</b>
<b class="nc">&nbsp;        this.minlon = minlon;</b>
<b class="nc">&nbsp;        this.maxlon = maxlon;</b>
&nbsp;
<b class="nc">&nbsp;        chunkColumnAmount = (int) Math.ceil(Math.abs(maxlon - minlon) / CHUNK_SIZE);</b>
<b class="nc">&nbsp;        chunkRowAmount = (int) Math.ceil(Math.abs(maxlat - minlat) / CHUNK_SIZE);</b>
&nbsp;
<b class="nc">&nbsp;        chunkAmount = chunkColumnAmount * chunkRowAmount;</b>
&nbsp;
<b class="nc">&nbsp;        chunks = new ArrayList&lt;ArrayList&lt;ArrayList&lt;Way&gt;&gt;&gt;(chunkAmount);</b>
<b class="nc">&nbsp;        for(int i = 0; i &lt; amountOfZoomLayers; i++){</b>
<b class="nc">&nbsp;            chunks.add(new ArrayList&lt;ArrayList&lt;Way&gt;&gt;());</b>
<b class="nc">&nbsp;            for (int j = 0; j &lt; chunkAmount; j++) {</b>
<b class="nc">&nbsp;                chunks.get(i).add(new ArrayList&lt;Way&gt;());</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        files = new File[amountOfZoomLayers][chunkAmount];</b>
&nbsp;
<b class="nc">&nbsp;        System.out.println(chunkRowAmount + &quot; &quot; + chunkColumnAmount);</b>
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            File folder = new File(&quot;zoomLayers&quot;);</b>
<b class="nc">&nbsp;            folder.mkdir();</b>
<b class="nc">&nbsp;            for(int i = 0; i &lt; amountOfZoomLayers; i++ ){</b>
<b class="nc">&nbsp;                File innerFolder = new File(&quot;zoomLayers/zoom&quot; + i);</b>
<b class="nc">&nbsp;                innerFolder.mkdir();</b>
<b class="nc">&nbsp;                for (int j = 0; j &lt; chunkAmount; j++) {</b>
<b class="nc">&nbsp;                    files[i][j] = new File(&quot;zoomLayers/zoom&quot; + i + &quot;/chunk&quot; + j +&quot;.txt&quot;);</b>
&nbsp;
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.out.println(&quot;failed &quot; + e.getMessage());</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private int coordsToChunkIndex(float lat, float lon) {
<b class="nc">&nbsp;        return (int) Math.floor((lon - minlon) / CHUNK_SIZE) +</b>
<b class="nc">&nbsp;                (int) Math.floor((lat - minlat) / CHUNK_SIZE) * chunkColumnAmount;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void addWay(Way way) { // main
<b class="nc">&nbsp;        rawWays.add(way);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void chunkWays() {
<b class="nc">&nbsp;        List&lt;Way&gt; newWays = rawWays;</b>
<b class="nc">&nbsp;        System.out.println(&quot;chunking: &quot; + newWays.size());</b>
<b class="nc">&nbsp;        rawWays = Collections.synchronizedList(new ArrayList&lt;&gt;(MIN_ARRAY_LENGTH));</b>
<b class="nc">&nbsp;        for(Way way : newWays) {</b>
<b class="nc">&nbsp;            byte zoomLevel = -1;</b>
<b class="nc">&nbsp;            String[] tags = way.getTags();</b>
<b class="nc">&nbsp;            for(String tag : tags){</b>
<b class="nc">&nbsp;                switch (tag) {</b>
&nbsp;                    case &quot;motorway&quot;:
&nbsp;                    case &quot;motorway_link&quot;:
&nbsp;                    case &quot;trunk&quot;:
&nbsp;                    case &quot;trunk_link&quot;:
&nbsp;                    case &quot;primary&quot;:
&nbsp;                    case &quot;primary_link&quot;:
&nbsp;
&nbsp;                    case &quot;water&quot;:
&nbsp;                    case &quot;wetland&quot;:
&nbsp;                    case &quot;bay&quot;:
&nbsp;                    case &quot;beach&quot;:
&nbsp;                    case &quot;coastline&quot;:
&nbsp;                    case &quot;cape&quot;:
&nbsp;                    case &quot;fell&quot;:
&nbsp;                    case &quot;grassland&quot;:
&nbsp;                    case &quot;heath&quot;:
&nbsp;                    case &quot;scrub&quot;:
&nbsp;                    case &quot;wood&quot;:
&nbsp;                    case &quot;aerodrome&quot;:
<b class="nc">&nbsp;                        zoomLevel = 4;</b>
<b class="nc">&nbsp;                        break;</b>
&nbsp;                    case &quot;secondary&quot;:
&nbsp;                    case &quot;secondary_link&quot;:
&nbsp;                    case &quot;rail&quot;:
&nbsp;                    case &quot;light_rail&quot;:
<b class="nc">&nbsp;                        if(zoomLevel &lt; 3) zoomLevel = 3;</b>
&nbsp;                        break;
&nbsp;                    case &quot;runway&quot;:
&nbsp;                    case &quot;tertiary&quot;:
&nbsp;                    case &quot;tertiary_link&quot;:
&nbsp;                    case &quot;unclassified&quot;:
&nbsp;                    case &quot;residential&quot;:
<b class="nc">&nbsp;                        if(zoomLevel &lt; 2) zoomLevel = 2;</b>
&nbsp;                        break;
&nbsp;                    case &quot;terminal&quot;:
&nbsp;                    case &quot;gate&quot;:
<b class="nc">&nbsp;                        if(zoomLevel &lt; 1) zoomLevel = 1;</b>
&nbsp;                        break;
&nbsp;                    case &quot;building&quot;:
&nbsp;                    case &quot;highway&quot;:
<b class="nc">&nbsp;                        if(zoomLevel &lt; 0) zoomLevel = 0;</b>
&nbsp;                        break;
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            if(zoomLevel == -1) continue;</b>
&nbsp;            //way.setZoomLevel( zoomLevel);
&nbsp;
<b class="nc">&nbsp;            float[] coords = way.getCoords();</b>
<b class="nc">&nbsp;            for (int i = 0; i &lt; coords.length; i += 2) {</b>
<b class="nc">&nbsp;                float lat = coords[i];</b>
<b class="nc">&nbsp;                float lon = coords[i + 1];</b>
&nbsp;
<b class="nc">&nbsp;                int chunkIndex = coordsToChunkIndex(lat, lon);</b>
&nbsp;
<b class="nc">&nbsp;                if (chunkIndex &lt; chunkAmount &amp;&amp; chunkIndex &gt;= 0) {</b>
<b class="nc">&nbsp;                    chunks.get(zoomLevel).get(chunkIndex).add(way);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    public void run() {
<b class="nc">&nbsp;        hasMoreWork = true;</b>
<b class="nc">&nbsp;        while (hasMoreWork || rawWays.size() &gt; 0) {</b>
<b class="nc">&nbsp;            if(rawWays.size() &lt; 100_000 &amp;&amp; hasMoreWork) {</b>
&nbsp;                try {
<b class="nc">&nbsp;                    Thread.sleep(10);</b>
<b class="nc">&nbsp;                } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                }</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            chunks = new ArrayList&lt;ArrayList&lt;ArrayList&lt;Way&gt;&gt;&gt;(chunkAmount);</b>
<b class="nc">&nbsp;            for(int i = 0; i &lt; amountOfZoomLayers; i++){</b>
<b class="nc">&nbsp;                chunks.add(new ArrayList&lt;ArrayList&lt;Way&gt;&gt;());</b>
<b class="nc">&nbsp;                for (int j = 0; j &lt; chunkAmount; j++) {</b>
<b class="nc">&nbsp;                    chunks.get(i).add(new ArrayList&lt;Way&gt;());</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            chunkWays();</b>
&nbsp;
<b class="nc">&nbsp;            writeFiles();</b>
&nbsp;        }
<b class="nc">&nbsp;        System.out.println(&quot;Finished while loop&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void writeFiles() {
<b class="nc">&nbsp;        IntStream.range(0, amountOfZoomLayers).forEach(i -&gt; {</b>
<b class="nc">&nbsp;            IntStream.range(0, chunks.get(i).size()).parallel().forEach(j -&gt; {</b>
&nbsp;                try {
&nbsp;
<b class="nc">&nbsp;                    DataOutputStream stream = new DataOutputStream(</b>
&nbsp;                            new BufferedOutputStream(new FileOutputStream(files[i][j], true)));
<b class="nc">&nbsp;                    for (Way way : chunks.get(i).get(j)) {</b>
<b class="nc">&nbsp;                        way.stream(stream);</b>
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    stream.close();</b>
<b class="nc">&nbsp;                } catch (FileNotFoundException e) {</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                } catch (IOException e) {</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                } catch (NullPointerException e){</b>
<b class="nc">&nbsp;                    System.out.println(&quot;e.getMessage()&quot;);</b>
<b class="nc">&nbsp;                    e.printStackTrace();</b>
<b class="nc">&nbsp;                }</b>
&nbsp;            });
&nbsp;        });
&nbsp;        
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            writeConfig();</b>
<b class="nc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private void writeConfig() throws IOException {
<b class="nc">&nbsp;        FileWriter writer = new FileWriter(&quot;zoomLayers/config&quot;);</b>
<b class="nc">&nbsp;        StringBuilder builder = new StringBuilder();</b>
<b class="nc">&nbsp;        builder.append(&quot;minlat: &quot;).append(minlat).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;maxlat: &quot;).append(maxlat).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;minlon: &quot;).append(minlon).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;maxlon: &quot;).append(maxlon).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;chunkColumnAmount: &quot;).append(chunkColumnAmount).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;chunkRowAmount: &quot;).append(chunkRowAmount).append(&quot;\n&quot;)</b>
<b class="nc">&nbsp;        .append(&quot;chunkAmount: &quot;).append(chunkAmount).append(&quot;\n&quot;);</b>
<b class="nc">&nbsp;        writer.write(builder.toString());</b>
<b class="nc">&nbsp;        writer.close();</b>
&nbsp;    }
&nbsp;
&nbsp;    public void printAll() {
<b class="nc">&nbsp;        for (int i = 0; i &lt; chunks.size(); i++) {</b>
&nbsp;            // System.out.println(chunks.get(i);
<b class="nc">&nbsp;            System.out.println(&quot;nr &quot; + i + &quot;: &quot; + chunks.get(i).size());</b>
&nbsp;        }
<b class="nc">&nbsp;        System.out.println(tempCounter);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setWays(ArrayList&lt;Way&gt; rawWay) {
<b class="nc">&nbsp;        this.rawWays = rawWay;</b>
&nbsp;    }
&nbsp;
&nbsp;    public void finishWork() {
<b class="nc">&nbsp;        hasMoreWork = false;</b>
&nbsp;        try {
<b class="nc">&nbsp;            chunkingThread.join();</b>
<b class="nc">&nbsp;        } catch (InterruptedException e) {</b>
<b class="nc">&nbsp;            e.printStackTrace();</b>
<b class="nc">&nbsp;        }</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-03-19 15:23</div>
</div>
</body>
</html>
